<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pop &mdash; dPBE: Discrete Population Balance Equations 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            dPBE: Discrete Population Balance Equations
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../attributes.html">Attributes of the dPBE Class</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_guide.html">Advanced Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../pop.html">pop module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">PSD_opt</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dPBE: Discrete Population Balance Equations</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">pop</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pop</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot; Solving 1D, 2D and 3D discrete population balance equations for agglomerating systems. &quot;&quot;&quot;</span>

<span class="c1">### ------ IMPORTS ------ ###</span>
<span class="c1">## General</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">integrate</span>
<span class="c1">## jit function</span>
<span class="kn">import</span> <span class="nn">func.jit_pop</span> <span class="k">as</span> <span class="nn">jit</span>
<span class="c1">## For plots</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">plotter.plotter</span> <span class="k">as</span> <span class="nn">pt</span>          
<span class="kn">from</span> <span class="nn">plotter.KIT_cmap</span> <span class="kn">import</span> <span class="n">c_KIT_green</span><span class="p">,</span> <span class="n">c_KIT_red</span><span class="p">,</span> <span class="n">c_KIT_blue</span>
<span class="c1">## For math</span>
<span class="kn">from</span> <span class="nn">func.func_math</span> <span class="kn">import</span> <span class="n">float_in_list</span><span class="p">,</span> <span class="n">float_equal</span><span class="p">,</span> <span class="n">isZero</span>

<span class="c1">### ------ POPULATION CLASS DEFINITION ------ ###</span>
<div class="viewcode-block" id="population"><a class="viewcode-back" href="../pop.html#pop.population">[docs]</a><span class="k">class</span> <span class="nc">population</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class definition for (discrete) population class</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dim : `int`</span>
<span class="sd">        Dimension of PBE in [1, 2, 3].</span>
<span class="sd">    disc : `str`, optional</span>
<span class="sd">        Discretization strategy in [&#39;uni&#39;, &#39;geo&#39;].</span>
<span class="sd">    file : `str`, optional</span>
<span class="sd">        Path to initialization file.</span>
<span class="sd">    t_exp : `float`, optional</span>
<span class="sd">        Agglomeration time in minutes.</span>
<span class="sd">    attr : </span>
<span class="sd">        Additional attributes to initialize. Can be any of the class attributes.</span>
<span class="sd">        </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">## Solve ODE with Scipy methods:</span>
<div class="viewcode-block" id="population.solve_PBE"><a class="viewcode-back" href="../pop.html#pop.population.solve_PBE">[docs]</a>    <span class="k">def</span> <span class="nf">solve_PBE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t_vec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Method for solving the (previously initialized) population with scipy.solve_ivp.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        t_max : `float`, optional</span>
<span class="sd">            Final agglomeration time in seconds.</span>
<span class="sd">        t_vec : `array_like`, optional</span>
<span class="sd">            Points in time (in seconds) at which to export the numerical solution.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># If t_vec is not given (=None), let solver decide where to export time data</span>
        <span class="k">if</span> <span class="n">t_max</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t_vec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">DEL_T</span>
        <span class="k">elif</span> <span class="n">t_vec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">t_vec</span><span class="p">)</span>
        
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Define right-hand-side function depending on discretization</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_1d_geo</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_art</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_1d_uni</span>                
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">THR_DN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RES</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> 
                                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> 
                                           <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_vec</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;LSODA&#39;</span><span class="p">,</span><span class="n">first_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
            
            <span class="c1"># Reshape and save result to N and t_vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">y</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">t</span>
            
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Define right-hand-side function depending on discretization</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_2d_geo</span>
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_art</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_2d_uni</span>   
                <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">THR_DN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">RES</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> 
                                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_vec</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK23&#39;</span><span class="p">,</span><span class="n">first_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
            
            <span class="c1"># Reshape and save result to N and t_vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">t</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">t</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># Define right-hand-side function depending on discretization</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_3d_geo</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                <span class="n">rhs</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_3d_uni</span>   
                
            <span class="bp">self</span><span class="o">.</span><span class="n">RES</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">rhs</span><span class="p">,</span> 
                                           <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">t_max</span><span class="p">],</span> 
                                           <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">t_eval</span><span class="o">=</span><span class="n">t_vec</span><span class="p">,</span>
                                           <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">THR_DN</span><span class="p">),</span>
                                           <span class="n">method</span><span class="o">=</span><span class="s1">&#39;RK23&#39;</span><span class="p">,</span><span class="n">first_step</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span><span class="n">rtol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">)</span>
            
            <span class="c1"># Reshape and save result to N and t_vec</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">t</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">RES</span><span class="o">.</span><span class="n">t</span></div>
             
    <span class="c1">## Solve ODE (forward Euler scheme):</span>
<div class="viewcode-block" id="population.solve_PBE_Euler"><a class="viewcode-back" href="../pop.html#pop.population.solve_PBE_Euler">[docs]</a>    <span class="k">def</span> <span class="nf">solve_PBE_Euler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; `(Legacy)` Simple solver with forward Euler. Use ``solve_PBE( )`` instead. &quot;&quot;&quot;</span>
        
        <span class="c1"># 2-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="p">):</span> 
                <span class="c1"># Calculate concentration change matrix depending on given timestep</span>
                <span class="n">DN</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">get_dNdt_2d_geo</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="n">tt</span><span class="p">],</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">THR_DN</span><span class="p">)</span>
                <span class="n">DN</span> <span class="o">=</span> <span class="n">DN</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span>       
                
                <span class="c1"># If timestep is too large, negative concentrations can occur!</span>
                <span class="n">tmp_N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="n">tt</span><span class="p">]</span><span class="o">+</span><span class="n">DN</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">DEL_T</span>
                
                <span class="c1"># if any(tmp_N[tmp_N&lt;0]):</span>
                <span class="c1">#     #print(&quot;! Negative values at t=&quot;,t,&quot;. Adjust time stepsize! Setting value of DN so that N(:,t+1)=0. &quot;)</span>
                <span class="c1">#     zeroflag = True</span>
                <span class="c1">#     # Adjust DN of the indices that would lead to negative values</span>
                <span class="c1">#     DN[tmp_N&lt;0] = -gv.N[tmp_N&lt;0,t]/gc.DEL_T;          </span>
                <span class="c1">#     # Calculate new tmp_N</span>
                <span class="c1">#     tmp_N = gv.N[:,:,t]+DN*gc.DEL_T</span>
                
                <span class="c1"># Update concentration matrix</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="n">tt</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_N</span>
                
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Euler solver is currently only implemented for the 2-D case.&#39;</span><span class="p">)</span></div>
    
    <span class="c1">## Full initialization of population instance (calc_R, init_N, calc_alpha_prim,</span>
    <span class="c1">##        calc_F_M, calc_B_M)</span>
<div class="viewcode-block" id="population.full_init"><a class="viewcode-back" href="../pop.html#pop.population.full_init">[docs]</a>    <span class="k">def</span> <span class="nf">full_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calc_alpha</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fully initialize a population instance.</span>
<span class="sd">        </span>
<span class="sd">        This method calls     </span>
<span class="sd">            * ``pop.calc_R( )`` </span>
<span class="sd">            * ``pop.init_N( )``   </span>
<span class="sd">            * ``pop.calc_alpha_prim( )`` (optional)</span>
<span class="sd">            * ``pop.calc_F_M( )`` </span>
<span class="sd">            * ``pop.calc_B_M( )`` </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calc_alpha : `bool`, optional</span>
<span class="sd">            If ``True``, calculate collision efficiency values from provided material data.     </span>
<span class="sd">            If ``False``, use pop.alpha_prim (initialize beforehand!)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_R</span><span class="p">()</span>
        <span class="c1"># self.calc_R_new()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_N</span><span class="p">()</span>        
        <span class="k">if</span> <span class="n">calc_alpha</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_alpha_prim</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_F_M</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_B_R</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_int_B_F</span><span class="p">()</span></div>
     
    <span class="c1">## Calculate R, V and X matrices (radii, total and partial volumes and volume fractions)</span>
<div class="viewcode-block" id="population.calc_R"><a class="viewcode-back" href="../pop.html#pop.population.calc_R">[docs]</a>    <span class="k">def</span> <span class="nf">calc_R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize discrete calculation grid. </span>
<span class="sd">        </span>
<span class="sd">        Creates the following class attributes: </span>
<span class="sd">            * ``pop.V``: Total Volume of each class </span>
<span class="sd">            * ``pop.R``: Radius of each class</span>
<span class="sd">            * ``pop.Xi_vol``: Volume fraction material i of each class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># Initialize V and R</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)):</span> <span class="c1">#range(0,self.NS):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>         
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>                    
            <span class="c1"># Initialize V, R and ratio matrices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span> 
            <span class="c1">## Large particle agglomeration may cause the integration to not converge. </span>
            <span class="c1">## A Limit can be placed on the particle size.</span>
            <span class="n">aggl_crit_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aggl_crit_ids</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">aggl_crit_ids</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span> <span class="o">=</span> <span class="n">aggl_crit_ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        
        <span class="c1"># 2-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="c1"># Initialize V1-V2 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span>
            <span class="c1"># self.V1[1] = 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)</span> 
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)):</span> <span class="c1">#range(0,self.NS):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="n">A1</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span>
            <span class="n">A3</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span>
            
            <span class="c1"># Initialize V, R and ratio matrices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            
            <span class="c1"># Write V1 and V3 in respective &quot;column&quot; of V</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span> 
            
            <span class="c1"># Calculate remaining entries of V and other matrices</span>
            <span class="c1"># range(1,X) excludes X itself -&gt; self.NS+2</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">A3</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">A3</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="c1">## Large particle agglomeration may cause the integration to not converge. </span>
            <span class="c1">## A Limit can be placed on the particle size.</span>
            <span class="n">aggl_crit_ids1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">aggl_crit_ids2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aggl_crit_ids1</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">aggl_crit_ids1</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggl_crit_ids1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">aggl_crit_ids2</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">aggl_crit_ids2</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggl_crit_ids2</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  
            <span class="k">else</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
        <span class="c1"># 3-D case                </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            
            <span class="c1"># Initialize V1-V3 </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">)</span> 
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> 
                <span class="c1"># Geometric grid</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;geo&#39;</span><span class="p">:</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R02</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                
                <span class="c1"># Uniform grid</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">==</span> <span class="s1">&#39;uni&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R02</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span>
            
            <span class="n">A1</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span>
            <span class="n">A2</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R02</span>
            <span class="n">A3</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span>
            
            <span class="c1"># Initialize V, R and ratio matrices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span><span class="o">-</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">X2_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">);</span> <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            
            <span class="c1"># Write V1 and V3 in respective &quot;column&quot; of V</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V2</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span> 
            
            <span class="c1"># Calculate remaining entries of V and other matrices</span>
            <span class="c1"># range(1,X) excludes X itself -&gt; self.NS+3</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">k</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X2_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X1_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">A2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">A3</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X2_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">A2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">A3</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">X3_a</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">A1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="n">A2</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">A3</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>
    
    <span class="c1">## Initialize concentration matrix N</span>
<div class="viewcode-block" id="population.init_N"><a class="viewcode-back" href="../pop.html#pop.population.init_N">[docs]</a>    <span class="k">def</span> <span class="nf">init_N</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> 
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize discrete number concentration array. </span>
<span class="sd">        </span>
<span class="sd">        Creates the following class attributes: </span>
<span class="sd">            * ``pop.N``: Number concentration of each class </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">USE_PSD</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V01</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;agglomeration&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;breakage&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;mix&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Current process_art not allowed!&quot;</span><span class="p">)</span>
        
        <span class="c1"># 2-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">USE_PSD</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V01</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V03</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;agglomeration&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N03</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;breakage&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">==</span> <span class="s2">&quot;mix&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N03</span>  
                    <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                
        
        <span class="c1"># 3-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">USE_PSD</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V01</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST2</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V02</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_initialize_psd</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">DIST3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V03</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N01</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N02</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N03</span></div>
    
    <span class="c1">## Calculate agglomeration rate matrix.</span>
    <span class="c1">## JIT_FM controls whether the pre-compiled function is used or not. </span>
<div class="viewcode-block" id="population.calc_F_M"><a class="viewcode-back" href="../pop.html#pop.population.calc_F_M">[docs]</a>    <span class="k">def</span> <span class="nf">calc_F_M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize agglomeration frequency array. </span>
<span class="sd">        </span>
<span class="sd">        Creates the following class attributes: </span>
<span class="sd">            * ``pop.F_M``: Agglomeration frequency between two classes ij and ab is stored in ``F_M[i,j,a,b]`` </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># To avoid mass leakage at the boundary in CAT, boundary cells are not directly involved in the calculation. </span>
            <span class="c1"># So there is no need to define the corresponding F_M at boundary. F_M is (NS-1)^2 instead (NS)^2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            
            <span class="c1"># Go through all agglomeration partners 1 [a] and 2 [i]</span>
            <span class="c1"># The current index tuple idx stores them as (a,i)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">):</span>
                <span class="c1"># Indices [a]=[0] and [i]=[0] not allowed!</span>
                <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Calculate the corresponding agglomeration efficiency</span>
                <span class="c1"># Add one to indices to account for borders</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="c1"># Calculate collision frequency beta depending on COLEVAL</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Chin 1998 (shear induced flocculation in stirred tanks)</span>
                    <span class="c1"># Optional reduction factor.</span>
                    <span class="c1"># corr_beta=1;</span>
                    <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">*</span><span class="mf">2.3</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span> <span class="c1"># [m^3/s]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Tsouris 1995 Brownian diffusion as controlling mechanism</span>
                    <span class="c1"># Optional reduction factor</span>
                    <span class="c1"># corr_beta=1;</span>
                    <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="c1">#[m^3/s]</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="c1"># Use a constant collision frequency given by CORR_BETA</span>
                    <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="c1"># Sum-Kernal (for validation) scaled by CORR_BETA</span>
                    <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
                                
                <span class="c1"># Calculate collision effiecieny depending on EFFEVAL. </span>
                <span class="c1"># Case(1): &quot;Correct&quot; calculation for given indices. Accounts for size effects in int_fun_2d</span>
                <span class="c1"># Case(2): Reduced model. Calculation only based on primary particles</span>
                <span class="c1"># Case(3): Alphas are pre-fed from ANN or other source.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># Not coded here</span>
                    <span class="n">alpha_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">alpha_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span>
                
                <span class="c1"># Calculate a correction factor to account for size dependency of alpha, depending on SIZEEVAL</span>
                <span class="c1"># Calculate lam</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># No size dependency of alpha</span>
                    <span class="n">corr_size</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># Case 3: Soos2007 (developed from Selomuya 2003). Empirical Equation</span>
                    <span class="c1"># with model parameters x and y. corr_size is lowered with lowered</span>
                    <span class="c1"># value of lambda (numerator) and with increasing particles size (denominator)</span>
                    <span class="n">corr_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span><span class="p">)</span>
                
                <span class="c1"># Store result</span>
                <span class="c1"># self.alpha[idx] = alpha_ai</span>
                <span class="c1"># self.beta[idx] = beta_ai</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_ai</span><span class="o">*</span><span class="n">alpha_ai</span><span class="o">*</span><span class="n">corr_size</span>
                
        <span class="c1"># 2-D case.</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JIT_FM</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">calc_F_M_2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">disc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># To avoid mass leakage at the boundary in CAT, boundary cells are not directly involved in the calculation. </span>
                <span class="c1"># So there is no need to define the corresponding F_M at boundary. F_M is (NS-1)^4 instead (NS)^4</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="c1"># Go through all agglomeration partners 1 [a,b] and 2 [i,j]</span>
                <span class="c1"># The current index tuple idx stores them as (a,b,i,j)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">):</span>
                    <span class="c1"># # Indices [a,b]=[0,0] and [i,j]=[0,0] not allowed!</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Calculate the corresponding agglomeration efficiency</span>
                    <span class="c1"># Add one to indices to account for borders</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">j</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    
                    <span class="c1"># Calculate collision frequency beta depending on COLEVAL</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Chin 1998 (shear induced flocculation in stirred tanks)</span>
                        <span class="c1"># Optional reduction factor.</span>
                        <span class="c1"># corr_beta=1;</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">*</span><span class="mf">2.3</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span> <span class="c1"># [m^3/s]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Tsouris 1995 Brownian diffusion as controlling mechanism</span>
                        <span class="c1"># Optional reduction factor</span>
                        <span class="c1"># corr_beta=1;</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]))</span> <span class="c1">#[m^3/s]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># Use a constant collision frequency given by CORR_BETA</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="c1"># Sum-Kernal (for validation) scaled by CORR_BETA</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
                    
                    <span class="c1"># Calculate probabilities, that particle 1 [a,b] is colliding as</span>
                    <span class="c1"># nonmagnetic 1 (NM1) or magnetic (M). Repeat for</span>
                    <span class="c1"># particle 2 [i,j]. Use area weighted composition.</span>
                    <span class="c1"># Calculate probability vector for all combinations. </span>
                    <span class="c1"># Indices: </span>
                    <span class="c1"># 1) a:N1 &lt;-&gt; i:N1  -&gt; X1[a,b]*X1[i,j]</span>
                    <span class="c1"># 2) a:N1 &lt;-&gt; i:M   -&gt; X1[a,b]*X3[i,j]</span>
                    <span class="c1"># 3) a:M  &lt;-&gt; i:N1  -&gt; X3[a,b]*X1[i,j]</span>
                    <span class="c1"># 4) a:M  &lt;-&gt; i:M   -&gt; X3[a,b]*X3[i,j]</span>
                    <span class="c1"># Use volume fraction (May be changed to surface fraction)</span>
                    <span class="n">X1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">;</span> <span class="n">X3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span>
                    
                    <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X1</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>\
                                <span class="n">X1</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">X3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>\
                                <span class="n">X3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span>\
                                <span class="n">X3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="n">X3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]])</span>
                    
                    <span class="c1"># Calculate collision effiecieny depending on EFFEVAL. </span>
                    <span class="c1"># Case(1): &quot;Correct&quot; calculation for given indices. Accounts for size effects in int_fun_2d</span>
                    <span class="c1"># Case(2): Reduced model. Calculation only based on primary particles</span>
                    <span class="c1"># Case(3): Alphas are pre-fed from ANN or other source.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Not coded here</span>
                        <span class="n">alpha_ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">alpha_ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">)</span>
                    
                    <span class="c1"># Calculate a correction factor to account for size dependency of alpha, depending on SIZEEVAL</span>
                    <span class="c1"># Calculate lam</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]:</span>
                        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># No size dependency of alpha</span>
                        <span class="n">corr_size</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Case 3: Soos2007 (developed from Selomuya 2003). Empirical Equation</span>
                        <span class="c1"># with model parameters x and y. corr_size is lowered with lowered</span>
                        <span class="c1"># value of lambda (numerator) and with increasing particles size (denominator)</span>
                        <span class="n">corr_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span><span class="p">)</span>
                    
                    <span class="c1"># Store result</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_ai</span><span class="o">*</span><span class="n">alpha_ai</span><span class="o">*</span><span class="n">corr_size</span>
                
        <span class="c1"># 3-D case. </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JIT_FM</span><span class="p">:</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">calc_F_M_3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">disc</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Initialize F_M Matrix. NOTE: F_M is defined without the border around the calculation grid</span>
                <span class="c1"># as e.g. N or V are (saving memory and calculations). </span>
                <span class="c1"># Thus, F_M is (NS+1)^6 instead of (NS+3)^6. As reference, V is (NS+3)^3.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="c1"># Go through all agglomeration partners 1 [a,b] and 2 [i,j]</span>
                <span class="c1"># The current index tuple idx stores them as (a,b,i,j)</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">):</span>
                    <span class="c1"># # Indices [a,b,c]=[0,0,0] and [i,j,k]=[0,0,0] not allowed!</span>
                    <span class="k">if</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="n">idx</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    
                    <span class="c1"># Calculate the corresponding agglomeration efficiency</span>
                    <span class="c1"># Add one to indices to account for borders</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    
                    <span class="c1"># Calculate collision frequency beta depending on COLEVAL</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Chin 1998 (shear induced flocculation in stirred tanks)</span>
                        <span class="c1"># Optional reduction factor.</span>
                        <span class="c1"># corr_beta=1;</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">*</span><span class="mf">2.3</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">3</span> <span class="c1"># [m^3/s]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Tsouris 1995 Brownian diffusion as controlling mechanism</span>
                        <span class="c1"># Optional reduction factor</span>
                        <span class="c1"># corr_beta=1;</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]))</span> <span class="c1">#[m^3/s]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># Use a constant collision frequency given by CORR_BETA</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                        <span class="c1"># Sum-Kernal (for validation) scaled by CORR_BETA</span>
                        <span class="n">beta_ai</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span>
                    
                    <span class="c1"># Calculate probabilities, that particle 1 [a,b,c] is colliding as</span>
                    <span class="c1"># nonmagnetic 1 (NM1), nonmagnetic 2 (NM2) or magnetic (M). Repeat for</span>
                    <span class="c1"># particle 2 [i,j,k]. Use area weighted composition.</span>
                    <span class="c1"># Calculate probability vector for all combinations. </span>
                    <span class="c1"># Indices: </span>
                    <span class="c1"># 1) a:N1 &lt;-&gt; i:N1  -&gt; X1[a,b,c]*X1[i,j,k]</span>
                    <span class="c1"># 2) a:N1 &lt;-&gt; i:N2  -&gt; X1[a,b,c]*X2[i,j,k]</span>
                    <span class="c1"># 3) a:N1 &lt;-&gt; i:M   -&gt; X1[a,b,c]*X3[i,j,k]</span>
                    <span class="c1"># 4) a:N2 &lt;-&gt; i:N1  -&gt; X2[a,b,c]*X1[i,j,k] </span>
                    <span class="c1"># 5) a:N2 &lt;-&gt; i:N2  -&gt; X2[a,b,c]*X2[i,j,k]</span>
                    <span class="c1"># 6) a:N2 &lt;-&gt; i:M   -&gt; X2[a,b,c]*X3[i,j,k]</span>
                    <span class="c1"># 7) a:M  &lt;-&gt; i:N1  -&gt; X3[a,b,c]*X1[i,j,k]</span>
                    <span class="c1"># 8) a:M  &lt;-&gt; i:N2  -&gt; X3[a,b,c]*X2[i,j,k]</span>
                    <span class="c1"># 9) a:M  &lt;-&gt; i:M   -&gt; X3[a,b,c]*X3[i,j,k]</span>
                    <span class="c1"># Use volume fraction (May be changed to surface fraction)</span>
                    <span class="n">X1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">;</span> <span class="n">X2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="p">;</span> <span class="n">X3</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span>
                    
                    <span class="n">p</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">X1</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X1</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X1</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X2</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X2</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X2</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X1</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X2</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span>\
                                <span class="n">X3</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="n">X3</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]])</span>
                    
                    <span class="c1"># Calculate collision effiecieny depending on EFFEVAL. </span>
                    <span class="c1"># Case(1): &quot;Correct&quot; calculation for given indices. Accounts for size effects in int_fun</span>
                    <span class="c1"># Case(2): Reduced model. Calculation only based on primary particles</span>
                    <span class="c1"># Case(3): Alphas are pre-fed from ANN or other source.</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># Not coded here</span>
                        <span class="n">alpha_ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">alpha_ai</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">)</span>
                    
                    <span class="c1"># Calculate a correction factor to account for size dependency of alpha, depending on SIZEEVAL</span>
                    <span class="c1"># Calculate lam</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
                        
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># No size dependency of alpha</span>
                        <span class="n">corr_size</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="c1"># Case 3: Soos2007 (developed from Selomuya 2003). Empirical Equation</span>
                        <span class="c1"># with model parameters x and y. corr_size is lowered with lowered</span>
                        <span class="c1"># value of lambda (numerator) and with increasing particles size (denominator)</span>
                        <span class="n">corr_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">lam</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R02</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span><span class="p">)</span>
                    
                    <span class="c1"># Store result</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">F_M</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta_ai</span><span class="o">*</span><span class="n">alpha_ai</span><span class="o">*</span><span class="n">corr_size</span></div>
    
    <span class="c1">## Calculate alphas of primary particles</span>
<div class="viewcode-block" id="population.calc_alpha_prim"><a class="viewcode-back" href="../pop.html#pop.population.calc_alpha_prim">[docs]</a>    <span class="k">def</span> <span class="nf">calc_alpha_prim</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate collision efficiency between primary particles based on material data.&quot;&quot;&quot;</span>
        
        <span class="c1"># Use reduced model if EFFEVAL==2. Only primary agglomeration efficiencies are calculated. </span>
        <span class="c1"># Due to numerical issues it may occur that the integral is 0, thus dividing by zero</span>
        <span class="c1"># This appears to be the case in fully destabilized systems --&gt; set the integral to 1</span>
        <span class="c1"># See 3-D case or int_fun for definition of comb_flag order</span>
    
        <span class="c1"># Define integration range</span>
        <span class="n">maxint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">minint</span> <span class="o">=</span> <span class="mi">2</span>
        
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># NM1 NM1</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            
        <span class="c1"># 2-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
            
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># NM1 M</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># M NM1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># M M</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
        <span class="c1"># 3-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            
            <span class="c1"># NM1 NM1 (0)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># NM1 NM2 (1)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># NM1 M (2)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># NM2 NM1 (3)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="c1"># NM2 NM2 (4)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># NM2 M (5)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="c1"># M NM1 (6)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="c1"># M NM2 (7)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
            
            <span class="c1"># M M (8)</span>
            <span class="n">tmp</span><span class="o">=</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fun</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="n">minint</span><span class="p">,</span> <span class="n">maxint</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tmp</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">:</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">tmp</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>    </div>
    
    <span class="c1">## Calculate breakage rate matrix. </span>
<div class="viewcode-block" id="population.calc_B_R"><a class="viewcode-back" href="../pop.html#pop.population.calc_B_R">[docs]</a>    <span class="k">def</span> <span class="nf">calc_B_R</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">## In breakage is not allowed to define parameter of particle without volume</span>
        <span class="c1">## So B_R is (NS-1) instead (NS)</span>
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">## Note: The breakage rate of the smallest particle is 0. </span>
            <span class="c1">## Note: Because particles with a volume of zero are skipped, </span>
            <span class="c1">##       calculation with V requires (index+1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Power Law Pandy and Spielmann --&gt; See Jeldres2018 (28)</span>
            <span class="c1"># for i in range(2,len(self.V)):</span>
            <span class="c1">#     self.B_M[i] = self.P1*self.G*(self.V[i]/self.V[2])**self.P2</span>
            
            <span class="c1"># Size independent breakage rate --&gt; See Leong2023 (10)</span>
            <span class="c1"># only for validation with analytical results</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKRVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
                
            <span class="c1"># Size dependent breakage rate --&gt; See Leong2023 (10)</span>
            <span class="c1"># only for validation with analytical results</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKRVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># 2-D case            </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            
            <span class="c1"># Size independent breakage rate --&gt; See Leong2023 (10)</span>
            <span class="c1"># only for validation with analytical results</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKRVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[:,:]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="c1"># Size dependent breakage rate --&gt; See Leong2023 (10)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKRVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">b</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="c1">## Note: Because of the conditional restrictions of breakage on the boundary, </span>
                    <span class="c1">##       1d calculation needs to be performed on the boundary.</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">B_R</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span></div>
                        
            
    <span class="c1">## Calculate integrated breakage function matrix.         </span>
<div class="viewcode-block" id="population.calc_int_B_F"><a class="viewcode-back" href="../pop.html#pop.population.calc_int_B_F">[docs]</a>    <span class="k">def</span> <span class="nf">calc_int_B_F</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">## In breakage is not allowed to define parameter of particle without volume</span>
        <span class="c1">## So int_B_F and intx_B_F is (NS-1)^2 instead (NS)^2</span>
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1">## Note: The breakage function of the smallest particle is 0. </span>
            <span class="c1">##       And small particle can not break into large one. </span>
            <span class="c1">## Note: Because particles with a volume of zero are skipped, </span>
            <span class="c1">##       calculation with V requires (index+1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="c1">## Let the integration range associated with the breakage function start from zero </span>
            <span class="c1">## to ensure mass conservation  </span>
            <span class="n">V_e_tem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span> 
            <span class="n">V_e_tem</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="n">V_e_tem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Conservation of Hypervolume, random breakage into four fragments --&gt; See Leong2023 (10)</span>
            <span class="c1"># only for validation with analytical results</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">B_F</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># Conservation of First-Order Moments, random breakage into two fragments --&gt; See Leong2023 (10)</span>
            <span class="c1"># only for validation with analytical results        </span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">B_F</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                    
        <span class="c1"># 2-D case</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">JIT_BF</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">calc_int_B_F_2D</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">V_e1_tem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span> 
                <span class="n">V_e1_tem</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">V_e1_tem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">V_e3_tem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">)</span> 
                <span class="n">V_e3_tem</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_e3</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">V_e3_tem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span> <span class="n">b</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="n">j</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a</span><span class="o">&lt;=</span><span class="n">i</span> <span class="ow">or</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1">## for left boundary/y</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1">## for low boundary/x</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span><span class="n">bf</span><span class="o">=</span><span class="n">B_F</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">B_F</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                            <span class="c1">## The contributions of fragments on the same vertical axis</span>
                            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">i</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">yb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">a</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">yb_integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V1</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                            <span class="c1">## The contributions of fragments on the same horizontal axis</span>
                            <span class="k">elif</span> <span class="n">b</span> <span class="o">==</span> <span class="n">j</span><span class="p">:</span>   
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">yb_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">V3</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                            <span class="c1">## The contribution from the fragments of large particles on the upper right side </span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">int_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">b_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">intx_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">xb_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inty_B_F</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">jit</span><span class="o">.</span><span class="n">yb_integrate</span><span class="p">(</span><span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e1_tem</span><span class="p">[</span><span class="n">a</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">V_e3_tem</span><span class="p">[</span><span class="n">b</span><span class="p">],</span> <span class="n">B_F</span><span class="p">)</span></div>
                
            
    <span class="c1">## Visualize / plot population:</span>
<div class="viewcode-block" id="population.visualize_distN_t"><a class="viewcode-back" href="../pop.html#pop.population.visualize_distN_t">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_distN_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t_pause</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="p">,</span><span class="mf">6.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">]):</span>
        <span class="c1"># Definition of t_plot:</span>
        <span class="c1"># None: Plot all available times</span>
        <span class="c1"># Numpy array in range [0,1] --&gt; Relative values of time indices</span>
        <span class="c1"># E.g. t_plot=np.array([0,0.5,1]) plots start, half-time and end</span>
        
        <span class="c1"># Double figsize in 3-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> 
            <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">frac_lnewdth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
        
        <span class="k">if</span> <span class="n">t_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t_plot</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            
        <span class="c1"># 1-D case: Plot PSD over time        </span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;For 1-D case executing visualize_qQ_t instead.&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">visualize_qQ_t</span><span class="p">(</span><span class="n">t_plot</span><span class="o">=</span><span class="n">tmp</span><span class="p">,</span><span class="n">t_pause</span><span class="o">=</span><span class="n">t_pause</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="n">close_all</span><span class="p">,</span>
                                                <span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span>
                                                <span class="n">show_x10</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_x50</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_x90</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">],</span> <span class="n">fig</span>
        
        <span class="c1"># 2-D case: Plot distribution over time</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_plot</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="s1">&#39;cb&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span> <span class="n">cb</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>                
                <span class="n">ax</span><span class="p">,</span><span class="n">cb</span><span class="p">,</span><span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_N2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="n">t</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:]),</span>
                                          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span><span class="n">t_stamp</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
            
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">t_pause</span><span class="p">)</span>
        
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span>
            
        <span class="c1"># 3-D case: Plot distributions over time   </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">ax1</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax3</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax4</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
            
            <span class="c1">#Calculate date for distribution plot:</span>
            <span class="n">Xt</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">t_plot</span><span class="p">)))</span>
    
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_plot</span><span class="p">:</span>
                <span class="n">Ntmp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="n">t</span><span class="p">]</span>
                <span class="n">Nagg</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,</span><span class="mi">1</span><span class="p">])</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,:])</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">Nagg</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">Xt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Nagg</span>
                    <span class="n">Xt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Nagg</span>
                    <span class="n">Xt</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Ntmp</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">!=</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">Nagg</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Xt</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> 
            
            <span class="n">Xt</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">Xt</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_plot</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="s1">&#39;cb1&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span> <span class="n">cb1</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="k">if</span> <span class="s1">&#39;cb2&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span> <span class="n">cb2</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>    
                <span class="k">if</span> <span class="s1">&#39;cb3&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span> <span class="n">cb3</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
                <span class="n">ax1</span><span class="p">,</span><span class="n">cb1</span><span class="p">,</span><span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_N2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">,</span><span class="n">t</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">),</span>
                                            <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">ax2</span><span class="p">,</span><span class="n">cb2</span><span class="p">,</span><span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_N2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="n">t</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">),</span>
                                            <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                <span class="n">ax3</span><span class="p">,</span><span class="n">cb3</span><span class="p">,</span><span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_N2D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:,</span><span class="n">t</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">),</span>
                                            <span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">)</span>
                
                
                <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Partial volume comp. 3 $V_</span><span class="si">{3}</span><span class="s1">$ ($k$) / $-$&#39;</span><span class="p">)</span>  <span class="c1"># Add a y-label to the axes.</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Partial volume comp. 2 $V_</span><span class="si">{2}</span><span class="s1">$ ($k$) / $-$&#39;</span><span class="p">)</span>  <span class="c1"># Add a y-label to the axes.</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Partial volume comp. 3 $V_</span><span class="si">{3}</span><span class="s1">$ ($k$) / $-$&#39;</span><span class="p">)</span>  <span class="c1"># Add a y-label to the axes.</span>
                
                <span class="n">ax4</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
                <span class="n">ax4</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Xt</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span>
                                        <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Agglomeration time $t_\mathrm</span><span class="si">{A}</span><span class="s1">$ / $-$&#39;</span><span class="p">,</span>
                                        <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;Agglomerate composition / $-$&#39;</span><span class="p">,</span>
                                        <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">plt_type</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">leg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax4</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Xt</span><span class="p">[</span><span class="mi">1</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Xt</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> 
                                        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">plt_type</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">leg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax4</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Xt</span><span class="p">[</span><span class="mi">2</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Xt</span><span class="p">[</span><span class="mi">1</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Xt</span><span class="p">[</span><span class="mi">0</span><span class="p">,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> 
                                        <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax4</span><span class="p">,</span> <span class="n">lbl</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">plt_type</span><span class="o">=</span><span class="s1">&#39;line&#39;</span><span class="p">,</span><span class="n">leg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">Xt</span><span class="p">[:,:</span><span class="n">t</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="p">[</span><span class="n">c_KIT_green</span><span class="p">,</span><span class="n">c_KIT_red</span><span class="p">,</span><span class="n">c_KIT_blue</span><span class="p">],</span>
                              <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Comp. 1&#39;</span><span class="p">,</span><span class="s1">&#39;Comp. 2&#39;</span><span class="p">,</span><span class="s1">&#39;Comp. 3&#39;</span><span class="p">])</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper right&#39;</span><span class="p">)</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[</span><span class="n">t</span><span class="p">])</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mf">1.6</span><span class="p">,</span>
                         <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
                
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
                <span class="n">ax4</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">t_pause</span><span class="p">)</span>
        
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        
            <span class="k">return</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">ax3</span><span class="p">,</span> <span class="n">ax4</span><span class="p">],</span> <span class="n">fig</span></div>
    
    <span class="c1">## Visualize / plot density and sum distribution:</span>
<div class="viewcode-block" id="population.visualize_qQ_t"><a class="viewcode-back" href="../pop.html#pop.population.visualize_qQ_t">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_qQ_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t_plot</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t_pause</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="p">,</span><span class="mf">6.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">],</span>
                       <span class="n">show_x10</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">show_x50</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_x90</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Definition of t_plot:</span>
        <span class="c1"># None: Plot all available times</span>
        <span class="c1"># Numpy array in range [0,1] --&gt; Relative values of time indices</span>
        <span class="c1"># E.g. t_plot=np.array([0,0.5,1]) plots start, half-time and end</span>
        
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
        
        <span class="c1"># Initialize plot</span>
        <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
        <span class="n">ax1</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> 
        <span class="n">ax2</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">t_plot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">t_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">t_plot</span><span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_plot</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">return_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_plot</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="mf">1e6</span>
        
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">t_plot</span><span class="p">:</span>

            <span class="c1"># Calculate distribution</span>
            <span class="n">x_uni</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_10</span><span class="p">,</span> <span class="n">x_50</span><span class="p">,</span> <span class="n">x_90</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">return_distribution</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
            
            <span class="n">ax1</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            
            <span class="n">ax1</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">x_uni</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">plt_type</span><span class="o">=</span><span class="s1">&#39;scatter&#39;</span><span class="p">,</span>
                                <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Particle Diameter $x$ / $\mu$m&#39;</span><span class="p">,</span>
                                <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;Volume density distribution $q_3$ / $-$&#39;</span><span class="p">,</span>
                                <span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">leg</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_uni</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span><span class="n">x_uni</span><span class="p">[</span><span class="n">q3</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span><span class="s1">&#39;q&#39;</span><span class="p">:</span><span class="n">q3</span><span class="p">[</span><span class="n">q3</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">]}),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">weights</span><span class="o">=</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> 
                              <span class="n">log_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_green</span><span class="p">)</span>
            
            <span class="n">ax2</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">x_uni</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span>
                                <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Particle Diameter $x$ / $\mu$m&#39;</span><span class="p">,</span>
                                <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;Volume sum distribution $Q_3$ / $-$&#39;</span><span class="p">,</span>
                                <span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">leg</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
            <span class="c1">#ax1.set_ylim([0,0.25])</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">show_x10</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_10</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_green</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_x10</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_10</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_green</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_x50</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_50</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_red</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_x50</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_50</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_red</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_x90</span><span class="p">:</span> <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_90</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_blue</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">show_x90</span><span class="p">:</span> <span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x_90</span><span class="o">*</span><span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c_KIT_blue</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span> 
            <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="n">t_pause</span><span class="p">)</span>
    
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>        
        
        <span class="k">return</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,</span> <span class="n">fig</span></div>

    <span class="c1">## Visualize / plot population:</span>
<div class="viewcode-block" id="population.visualize_sumN_t"><a class="viewcode-back" href="../pop.html#pop.population.visualize_sumN_t">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_sumN_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="p">,</span><span class="mf">6.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">]):</span>
        
        <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
            <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   
        
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">return_N_t</span><span class="p">(),</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                               <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Agglomeration time $t_\mathrm</span><span class="si">{A}</span><span class="s1">$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;Total number of agglomerates $\Sigma N$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="n">mrk</span><span class="p">)</span>
            
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
        
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span></div>
    
<div class="viewcode-block" id="population.visualize_sumvol_t"><a class="viewcode-back" href="../pop.html#pop.population.visualize_sumvol_t">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_sumvol_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sumvol</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="p">,</span><span class="mf">6.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">]):</span>
        
        <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
            <span class="n">ax</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   
        
        <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span><span class="n">sumvol</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                               <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Agglomeration time $t_\mathrm</span><span class="si">{A}</span><span class="s1">$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;Total volume of agglomerates $\Sigma N$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="n">mrk</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_mom_t</span><span class="p">()</span>
            <span class="n">mu_10</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span><span class="n">mu_10</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                   <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="n">mu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_mom_t</span><span class="p">()</span>
            <span class="n">mu_10</span> <span class="o">=</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">,</span><span class="n">mu_10</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                                   <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
        
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
        
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="population.visualize_distribution"><a class="viewcode-back" href="../pop.html#pop.population.visualize_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">visualize_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">lbl</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="p">,</span><span class="mf">6.4</span><span class="o">*</span><span class="mf">1.5</span><span class="p">]):</span>
        
        <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
            <span class="n">axq3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>   
            <span class="n">axQ3</span><span class="o">=</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>   
            
        
        <span class="n">axq3</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">x_uni</span><span class="p">,</span> <span class="n">q3</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axq3</span><span class="p">,</span>
                               <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Agglomeration size $x_\mathrm</span><span class="si">{A}</span><span class="s1">$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;volume distribution of agglomerates $q3$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="n">mrk</span><span class="p">)</span>
        
        <span class="n">axQ3</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_data</span><span class="p">(</span><span class="n">x_uni</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axQ3</span><span class="p">,</span>
                               <span class="n">xlbl</span><span class="o">=</span><span class="s1">&#39;Agglomeration size $x_\mathrm</span><span class="si">{A}</span><span class="s1">$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">ylbl</span><span class="o">=</span><span class="s1">&#39;volume distribution of agglomerates $Q3$ / $-$&#39;</span><span class="p">,</span>
                               <span class="n">lbl</span><span class="o">=</span><span class="n">lbl</span><span class="p">,</span><span class="n">clr</span><span class="o">=</span><span class="n">clr</span><span class="p">,</span><span class="n">mrk</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">)</span>

        <span class="n">axq3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
        <span class="n">axQ3</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>   
        
        <span class="k">return</span> <span class="n">axq3</span><span class="p">,</span> <span class="n">axQ3</span><span class="p">,</span> <span class="n">fig</span></div>
    
    <span class="c1">## Return particle size distribution on fixed grid </span>
<div class="viewcode-block" id="population.return_distribution"><a class="viewcode-back" href="../pop.html#pop.population.return_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">return_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">unique_with_tolerance</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
            <span class="n">V_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
            <span class="n">V_unique</span> <span class="o">=</span> <span class="p">[</span><span class="n">V_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            
            <span class="k">for</span> <span class="n">V_val</span> <span class="ow">in</span> <span class="n">V_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">V_val</span><span class="p">,</span> <span class="n">V_unique</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="o">*</span><span class="n">V_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">V_unique</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">V_val</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">V_unique</span><span class="p">)</span>
        <span class="c1"># If no N is provided use the one from the class instance</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        
        <span class="c1"># Extract unique values that are NOT -1 or 0 (border)</span>
        <span class="n">v_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># v_uni = unique_with_tolerance(v_uni)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sumvol_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sumvol_uni_tem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># Loop through all entries in V and add volume concentration to specific entry in sumvol_uni</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="c1"># if self.V[i] in v_uni:</span>
                    <span class="n">sumvol_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> 
                        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                        <span class="c1"># if self.V[i,j] in v_uni:</span>
                        <span class="n">sumvol_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                            <span class="c1"># if self.V[i,j,k] in v_uni:</span>
                            <span class="n">sumvol_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
            <span class="c1">## convert unit m into mm</span>
            <span class="n">sumV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sumvol_uni_tem</span><span class="p">)</span><span class="o">*</span><span class="mf">1e18</span>
            <span class="n">sumvol_uni</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sumvol_uni_tem</span><span class="o">*</span><span class="mf">1e18</span>
            <span class="c1"># Calculate diameter array</span>
            <span class="n">x_uni</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">v_uni</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">1e6</span>
            
            <span class="c1"># Calculate sum and density distribution</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sumvol_uni</span><span class="p">)</span><span class="o">/</span><span class="n">sumV</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x_uni</span><span class="p">)):</span>
                <span class="n">q3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q3</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_uni</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x_uni</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># Retrieve x10, x50 and x90 through interpolation</span>
            <span class="n">x_10</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>
            <span class="n">x_50</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>
            <span class="n">x_90</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>   
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Case for comp not coded yet. Exiting&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;x_uni&#39;</span><span class="p">:</span> <span class="n">x_uni</span><span class="p">,</span>
        <span class="s1">&#39;q3&#39;</span><span class="p">:</span> <span class="n">q3</span><span class="p">,</span>
        <span class="s1">&#39;Q3&#39;</span><span class="p">:</span> <span class="n">Q3</span><span class="p">,</span>
        <span class="s1">&#39;x_10&#39;</span><span class="p">:</span> <span class="n">x_10</span><span class="p">,</span>
        <span class="s1">&#39;x_50&#39;</span><span class="p">:</span> <span class="n">x_50</span><span class="p">,</span>
        <span class="s1">&#39;x_90&#39;</span><span class="p">:</span> <span class="n">x_90</span><span class="p">,</span>
        <span class="s1">&#39;sumvol_uni&#39;</span><span class="p">:</span> <span class="n">sumvol_uni</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flags</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="population.return_num_distribution"><a class="viewcode-back" href="../pop.html#pop.population.return_num_distribution">[docs]</a>    <span class="k">def</span> <span class="nf">return_num_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="c1"># If no N is provided use the one from the class instance</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span>
        
        <span class="c1"># Extract unique values that are NOT -1 or 0 (border)</span>
        <span class="c1"># At the same time, v_uni will be rearranged according to size.</span>
        <span class="n">v_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">x_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sumN_uni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sumN_uni_tem</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v_uni</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">comp</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="c1"># Loop through all entries in V and add volume concentration to specific entry in sumN_uni</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">float_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">v_uni</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">sumN_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> 
                        
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">float_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">],</span> <span class="n">v_uni</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="n">sumN_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">NS</span><span class="o">+</span><span class="mi">3</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">float_in_list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">],</span> <span class="n">v_uni</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
                                <span class="n">sumN_uni_tem</span><span class="p">[</span><span class="n">v_uni</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]]</span> <span class="o">+=</span> <span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">]</span>
                                
            <span class="n">sumN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sumN_uni_tem</span><span class="p">)</span>
            <span class="n">sumN_uni</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">sumN_uni_tem</span>
            <span class="c1"># Calculate diameter array and convert into mm</span>
            <span class="n">x_uni</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">v_uni</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">1e6</span>
            
            <span class="c1"># Calculate sum and density distribution</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">sumN_uni</span><span class="p">)</span><span class="o">/</span><span class="n">sumN</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x_uni</span><span class="p">)):</span>
                <span class="n">q3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q3</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">x_uni</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x_uni</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
            <span class="c1"># Retrieve x10, x50 and x90 through interpolation</span>
            <span class="n">x_10</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>
            <span class="n">x_50</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>
            <span class="n">x_90</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">Q3</span><span class="p">,</span> <span class="n">x_uni</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Case for comp not coded yet. Exiting&#39;</span><span class="p">)</span>
            <span class="k">return</span>
    
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;x_uni&#39;</span><span class="p">:</span> <span class="n">x_uni</span><span class="p">,</span>
        <span class="s1">&#39;q3&#39;</span><span class="p">:</span> <span class="n">q3</span><span class="p">,</span>
        <span class="s1">&#39;Q3&#39;</span><span class="p">:</span> <span class="n">Q3</span><span class="p">,</span>
        <span class="s1">&#39;x_10&#39;</span><span class="p">:</span> <span class="n">x_10</span><span class="p">,</span>
        <span class="s1">&#39;x_50&#39;</span><span class="p">:</span> <span class="n">x_50</span><span class="p">,</span>
        <span class="s1">&#39;x_90&#39;</span><span class="p">:</span> <span class="n">x_90</span><span class="p">,</span>
        <span class="s1">&#39;sumN_uni&#39;</span><span class="p">:</span> <span class="n">sumN_uni</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outputs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flags</span> <span class="o">=</span> <span class="n">flag</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">outputs</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flags</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">)</span></div>
        
    <span class="c1">## Return total number. For t=None return full array, else return total number at time index t </span>
<div class="viewcode-block" id="population.return_N_t"><a class="viewcode-back" href="../pop.html#pop.population.return_N_t">[docs]</a>    <span class="k">def</span> <span class="nf">return_N_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="c1"># 1-D case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,</span><span class="n">t</span><span class="p">])</span>  
            
        <span class="c1"># 2-D case    </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">])</span>
        
        <span class="c1"># 3-D case    </span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="n">t</span><span class="p">])</span></div>
    
    <span class="c1"># Calculate distribution moments mu(i,j,t)</span>
<div class="viewcode-block" id="population.calc_mom_t"><a class="viewcode-back" href="../pop.html#pop.population.calc_mom_t">[docs]</a>    <span class="k">def</span> <span class="nf">calc_mom_t</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)))</span>
        
        <span class="c1"># Time loop</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">**</span><span class="n">i</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,</span><span class="n">t</span><span class="p">])</span>
                    
                <span class="c1"># The following only applies for 2D and 3D case</span>
                <span class="c1"># Moment between component 1 and 3</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">**</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">**</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="n">t</span><span class="p">])</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">mu</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">**</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span><span class="o">**</span><span class="n">j</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="n">t</span><span class="p">])</span>
                        
        <span class="k">return</span> <span class="n">mu</span></div>
    
    <span class="c1">## Perform magnetic separation and return separation efficiencies</span>
<div class="viewcode-block" id="population.mag_sep"><a class="viewcode-back" href="../pop.html#pop.population.mag_sep">[docs]</a>    <span class="k">def</span> <span class="nf">mag_sep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="c1"># Initialize separation matrix and result array</span>
        <span class="n">T_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))</span>
        <span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># T[0]: overall separation efficiency, T[1-3]: component 1-3       </span>
        
        <span class="c1"># Calculate model constants</span>
        <span class="n">c2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">TC2</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TC2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">TC1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TC1</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">c1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">TC1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">TC1</span><span class="p">)</span><span class="o">*</span><span class="mi">9</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="o">/</span><span class="p">(</span><span class="n">c2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_M</span><span class="p">)</span>
        
        <span class="c1"># 1-D case not available</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Magnetic separation not possible in 1-D case.&#39;</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># Calculate T_m (Separation efficiency matrix)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">i</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">j</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>                
                    <span class="n">T_m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_M</span><span class="o">*</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="p">)))</span>
            
            <span class="c1"># Calculate overall separation efficiency</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Calculate separation efficiency of component 1</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Calculate separation efficiency of component 3</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Calculate T_m (Separation efficiency matrix)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tmp</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndenumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">i</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">j</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">k</span><span class="o">=</span><span class="n">idx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>                
                    <span class="n">T_m</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_M</span><span class="o">*</span><span class="n">c1</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">9</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span><span class="p">)))</span>
            
            <span class="c1"># Calculate overall separation efficiency</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Calculate separation efficiency of component 1</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X1_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Calculate separation efficiency of component 2</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X2_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
            <span class="c1"># Calculate separation efficiency of component 3</span>
            <span class="n">T</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">100</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">*</span><span class="n">T_m</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">X3_vol</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">T</span><span class="p">,</span> <span class="n">T_m</span></div>

    <span class="c1">## Integral function of interaction potential</span>
<div class="viewcode-block" id="population.int_fun"><a class="viewcode-back" href="../pop.html#pop.population.int_fun">[docs]</a>    <span class="k">def</span> <span class="nf">int_fun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">k</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">comb_flag</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        
        <span class="c1"># Generate corresponding psi, A, c1 and c2 values for given case.</span>
        <span class="c1"># Hamaker combination equation from Butt(2018) equation 3.86</span>
        <span class="c1"># comb_flag order same as in alpha_prim: NM1 NM1 (0) | NM1 NM2 (1) | </span>
        <span class="c1"># NM1 M (2) | NM2 NM1 (3)=(1) | NM2 NM2 (4) | NM2 M (5) | </span>
        <span class="c1"># M NM1 (6)=(2) | M NM2 (7)=(5) | M M (8)</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>     <span class="c1"># a:NM1 i:NM1</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI1</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI1</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM1NM1</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM1NM1</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_NM1NM1</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span>     <span class="c1"># a:NM1 i:NM2</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI1</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI2</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM1NM2</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM1NM2</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_NM1NM1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_NM2NM2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">2</span> <span class="ow">or</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span>     <span class="c1"># a:NM1 i:M</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI1</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI3</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_MNM1</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_MNM1</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_NM1NM1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_MM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span>     <span class="c1"># a:NM2 i:NM2</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI2</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI2</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM2NM2</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM2NM2</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_NM2NM2</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">5</span> <span class="ow">or</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">7</span><span class="p">:</span>     <span class="c1"># a:NM2 i:M</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI2</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI3</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_MNM2</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_MNM2</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A_NM2NM2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">A_MM</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comb_flag</span><span class="o">==</span><span class="mi">8</span><span class="p">:</span>     <span class="c1"># a:M i:M</span>
            <span class="n">psi_a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI3</span>
            <span class="n">psi_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PSI3</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C1_MM</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C2_MM</span>
            <span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A_MM</span>
        
        <span class="n">gam1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">*</span><span class="n">psi_a</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">gam2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tanh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">*</span><span class="n">psi_i</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EPS</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">]</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span>
            
        <span class="n">a_dist</span> <span class="o">=</span> <span class="p">(</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">a_dist</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a_dist</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">POTEVAL</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Electric potential Gregory 1975 (Elimelech book Particle deposition </span>
            <span class="c1"># and aggregation), vdW potential sphere - sphere 3.23, hydrophobic </span>
            <span class="c1"># interaction / polar potential Christenson 2001 (bi-exponential model)</span>
            <span class="c1"># NOTE: Potentials are already divided by kT (For electrostatic</span>
            <span class="c1"># potential missing factor kT in comparison to formula)</span>
            <span class="n">Psi_el</span> <span class="o">=</span> <span class="mi">128</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="o">*</span><span class="n">gam1</span><span class="o">*</span><span class="n">gam2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">*</span><span class="n">a_dist</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">a_dist</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r1</span><span class="o">+</span><span class="n">r2</span><span class="p">))</span>
            <span class="n">Psi_vdw</span> <span class="o">=</span> <span class="o">-</span><span class="n">A</span><span class="o">*</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r2</span><span class="o">*</span><span class="n">h</span><span class="p">))</span><span class="o">+</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r2</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="p">))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r2</span><span class="o">*</span><span class="n">h</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">r2</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="p">)))</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="p">)</span>
            <span class="n">a_sqr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r1</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span>
            <span class="n">Psi_pol</span> <span class="o">=</span> <span class="o">-</span><span class="n">a_sqr</span><span class="o">*</span><span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">LAM1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">LAM1</span><span class="p">)</span><span class="o">+</span><span class="n">c2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">LAM2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">LAM2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KT</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">Psi_el</span><span class="o">+</span><span class="n">Psi_vdw</span><span class="o">+</span><span class="n">Psi_pol</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Prevent potential overflow from ruining the results</span>
            <span class="c1"># When np.exp overflows, the result is inf</span>
            <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">y</span> <span class="o">=</span> <span class="mf">1e90</span>
    
        <span class="c1"># Elimelech page 174 aka. Honig(1971) correction factor</span>
        <span class="k">if</span> <span class="n">s</span><span class="o">!=</span><span class="mi">2</span><span class="p">:</span> <span class="n">bet</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">13</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">bet</span> <span class="o">=</span> <span class="mf">1e10</span>
        
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">bet</span>
            
        <span class="k">return</span> <span class="n">y</span> </div>
    
    <span class="c1">## Save Variables to file:</span>
<div class="viewcode-block" id="population.save_vars"><a class="viewcode-back" href="../pop.html#pop.population.save_vars">[docs]</a>    <span class="k">def</span> <span class="nf">save_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">file</span><span class="p">):</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>
            
    <span class="c1">## Initialize:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">t_exp</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">disc</span><span class="o">=</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">attr</span><span class="p">):</span>
        
        <span class="c1"># Check if given dimension and discretization is valid</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="ow">and</span> <span class="n">disc</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;geo&#39;</span><span class="p">,</span><span class="s1">&#39;uni&#39;</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Given dimension and/or discretization are not valid. Exiting..&#39;</span><span class="p">)</span>
            
        <span class="c1"># BASELINE PATH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pth</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span> <span class="vm">__file__</span> <span class="p">)</span>
        
        <span class="c1">## MODEL parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>                        <span class="c1"># Dimension (1=1D, 2=2D, 3=3D)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">disc</span> <span class="o">=</span> <span class="n">disc</span>                      <span class="c1"># &#39;geo&#39;: geometric grid, &#39;uni&#39;: uniform grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DEL_T</span> <span class="o">=</span> <span class="mi">1</span>                        <span class="c1"># Time stepsize [s]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NS</span> <span class="o">=</span> <span class="mi">12</span>                          <span class="c1"># Grid parameter [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="mi">2</span>                            <span class="c1"># Geometric grid ratio (V[i] = S*V[i-1])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">JIT_DN</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># Define wheter or not the DN calculation (timeloop) should be precompiled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">JIT_FM</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># Define wheter or not the FM calculation should be precompiled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">JIT_BF</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">COLEVAL</span> <span class="o">=</span> <span class="mi">1</span>                      <span class="c1"># Case for calculation of beta. 1 = Orthokinetic, 2 = Perikinetic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EFFEVAL</span> <span class="o">=</span> <span class="mi">2</span>                      <span class="c1"># Case for calculation of alpha. 1 = Full calculation, 2 = Reduced model (only based on primary particle interactions)</span>
                                            <span class="c1"># Case 2 massively faster and legit acc. to Kusters1997 and Bäbler2008</span>
                                            <span class="c1"># Case 3 to use pre-defines alphas (e.g. from ANN) --&gt; alphas need to be provided at some point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BREAKFVAL</span> <span class="o">=</span> <span class="mi">2</span>                    <span class="c1"># Case for calculation breakage function. 1 = conservation of Hypervolume, 2 = conservation of 0 Moments </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">BREAKRVAL</span> <span class="o">=</span> <span class="mi">2</span>                    <span class="c1"># Case for calculation breakage rate. 1 = constant, 2 = size dependent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggl_crit</span> <span class="o">=</span> <span class="mf">1e3</span>                  <span class="c1"># Maximum aggregate volume allowed to further agglomeration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_art</span> <span class="o">=</span> <span class="s2">&quot;agglomeration&quot;</span>    <span class="c1"># &quot;agglomeration&quot;: only calculate agglomeration, &quot;breakage&quot;: only calculate breakage, &quot;mix&quot;: calculate both agglomeration and breakage</span>
                       
        <span class="bp">self</span><span class="o">.</span><span class="n">SIZEEVAL</span> <span class="o">=</span> <span class="mi">2</span>                     <span class="c1"># Case for implementation of size dependency. 1 = No size dependency, 2 = Model from Soos2007 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">POTEVAL</span> <span class="o">=</span> <span class="mi">1</span>                      <span class="c1"># Case for the set of used interaction potentials. See int_fun_Xd for infos.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">USE_PSD</span> <span class="o">=</span> <span class="kc">True</span>                   <span class="c1"># Define wheter or not the PSD should be initializes (False = monodisperse primary particles)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">FOLDERNAME</span> <span class="o">=</span> <span class="s1">&#39;210414_default&#39;</span>    <span class="c1"># Foldername in ../export/</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EXPORTNAME</span> <span class="o">=</span> <span class="s1">&#39;default&#39;</span>           <span class="c1"># Filename extension for export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GC_EXPSTR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                   <span class="c1"># Full exportstring of GC (only initialization, gets real value upon export)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">GV_EXPSTR</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>                   <span class="c1"># Full exportstring of GV (only initialization, gets real value upon export)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">REPORT</span> <span class="o">=</span> <span class="kc">True</span>                    <span class="c1"># When true, population informs about current calculation and reports results</span>
        
        
        <span class="c1"># NOTE: The following two parameters define the magnetic separation step.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC1</span> <span class="o">=</span> <span class="mf">1e-3</span>                       <span class="c1"># Separation efficiency of nonmagnetic particles. 0 and 1 not allowed!    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TC2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mf">1e-3</span>                     <span class="c1"># Separation efficiency of magnetic particles. 0 and 1 not allowed!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">THR_DN</span> <span class="o">=</span> <span class="mf">1e-10</span>                    <span class="c1"># Threshold for concentration change matrix (DN[DN&lt;THR]=0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_PSI</span> <span class="o">=</span> <span class="mi">1</span>                     <span class="c1"># Correction factor for zeta potentials in general</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_PSI_SIO2</span> <span class="o">=</span> <span class="mi">1</span>                <span class="c1"># Correction factor for SiO2 zeta potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_PSI_ZNO</span> <span class="o">=</span> <span class="mi">1</span>                 <span class="c1"># Correction factor for ZnO zeta potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_PSI_MAG</span> <span class="o">=</span> <span class="mi">1</span>                 <span class="c1"># Correction factor for MAG zeta potential</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_A</span> <span class="o">=</span> <span class="mi">1</span>                       <span class="c1"># Correction factor for Hamaker constants in general</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_A_SIO2</span> <span class="o">=</span> <span class="mi">1</span>                  <span class="c1"># Correction factor for SiO2 Hamaker constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_A_ZNO</span> <span class="o">=</span> <span class="mi">1</span>                   <span class="c1"># Correction factor for ZnO Hamaker constant</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_A_MAG</span> <span class="o">=</span> <span class="mi">1</span>                   <span class="c1"># Correction factor for MAG Hamaker constant</span>
        
        <span class="c1">## MATERIAL parameters:</span>
        <span class="c1"># NOTE: component 3 is defined as the magnetic component (both in 2D and 3D case)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R01</span> <span class="o">=</span> <span class="mf">2.9e-7</span>                     <span class="c1"># Radius primary particle component 1 [m] - NM1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R02</span> <span class="o">=</span> <span class="mf">2.9e-7</span>                     <span class="c1"># Radius primary particle component 2 [m] - NM2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R03</span> <span class="o">=</span> <span class="mf">2.9e-7</span>                     <span class="c1"># Radius primary particle component 3 [m] - M3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIST1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pth</span><span class="p">,</span><span class="s2">&quot;data</span><span class="se">\\</span><span class="s2">PSD_data</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;PSD_x50_1.0E-6_r01_2.9E-7.npy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIST2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pth</span><span class="p">,</span><span class="s2">&quot;data</span><span class="se">\\</span><span class="s2">PSD_data</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;PSD_x50_1.0E-6_r01_2.9E-7.npy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DIST3</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pth</span><span class="p">,</span><span class="s2">&quot;data</span><span class="se">\\</span><span class="s2">PSD_data</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;PSD_x50_1.0E-6_r01_2.9E-7.npy&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_prim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">dim</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSI1</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="mf">1e-3</span>                   <span class="c1"># Surface potential component 1 [V] - NM1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSI2</span> <span class="o">=</span> <span class="mi">1</span><span class="o">*</span><span class="mf">1e-3</span>                    <span class="c1"># Surface potential component 2 [V] - NM2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PSI3</span> <span class="o">=</span> <span class="o">-</span><span class="mi">40</span><span class="o">*</span><span class="mf">1e-3</span>                  <span class="c1"># Surface potential component 3 [V] - M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_NM1NM1</span> <span class="o">=</span> <span class="mf">10e-21</span>                <span class="c1"># Hamaker constant for interaction NM1-NM1 [J] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_NM2NM2</span> <span class="o">=</span> <span class="mf">10e-21</span>                <span class="c1"># Hamaker constant for interaction NM2-NM2 [J]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A_MM</span> <span class="o">=</span> <span class="mf">80e-21</span>                    <span class="c1"># Hamaker constant for interaction M-M [J]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_N1</span> <span class="o">=</span> <span class="mf">505.09</span>                <span class="c1"># Saturization magnetization component 1 [A/m] - NM1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_N2</span> <span class="o">=</span> <span class="mf">505.09</span>                <span class="c1"># Saturization magnetization component 2 [A/m] - NM2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_M</span> <span class="o">=</span> <span class="mf">20.11</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">5</span>            <span class="c1"># Saturization magnetization component 3 [A/m] - M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_N1</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>            <span class="c1"># Critical magnetic field strength where NM1 is saturated [A/m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_N2</span> <span class="o">=</span> <span class="mi">300</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>            <span class="c1"># Critical magnetic field strength where NM2 is saturated [A/m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_M</span> <span class="o">=</span> <span class="mi">200</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">3</span>             <span class="c1"># Critical magnetic field strength where M is saturated [A/m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XI_N1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_N1</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_N1</span>    <span class="c1"># Magnetic susceptibility component 1 [-] (linear approximation)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XI_N2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_N2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_N2</span>    <span class="c1"># Magnetic susceptibility component 2 [-] (linear approximation)  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">XI_M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">M_SAT_M</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">H_CRIT_M</span>       <span class="c1"># Magnetic susceptibility component 3 [-] (linear approximation)</span>
        
        <span class="c1"># Definition of hydrophobic interaction parameters according to bi-exponential empiric </span>
        <span class="c1"># equation from Christenson2001 [N/m]. Naming is as follows: C{i}_{j}{k}, where</span>
        <span class="c1"># i element of [1,2], 1 = Short ranged interaction, 2 = long ranged interaction</span>
        <span class="c1"># j element of [NM1, NM2, M] = Interaction partner 1</span>
        <span class="c1"># k element of [NM1, NM2, M] = Interaction partner 2</span>
        <span class="c1"># &quot;Good&quot; default values are C1_jk=5e-3, C2_ij=50e-3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM1NM1</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM1NM1</span> <span class="o">=</span> <span class="mi">0</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_MNM1</span> <span class="o">=</span> <span class="mi">0</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_MNM1</span> <span class="o">=</span> <span class="mi">0</span>      
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_MM</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_MM</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM2NM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM2NM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_MNM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_MNM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C1_NM1NM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C2_NM1NM2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LAM1</span> <span class="o">=</span> <span class="mf">1.2</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">9</span>                <span class="c1"># Range of short ranged hydrophobic interations [m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">LAM2</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">9</span>                 <span class="c1"># Range of long ranged hydrophobic interations [m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_CR</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">9</span>                  <span class="c1"># Alternative range criterion hydrophobic interactions </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_SEL</span> <span class="o">=</span> <span class="mf">0.310601</span>                 <span class="c1"># Size dependency parameter for Selomulya2003 / Soos2006 </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_SEL</span> <span class="o">=</span> <span class="mf">1.06168</span>                  <span class="c1"># Size dependency parameter for Selomulya2003 / Soos2006</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1</span> <span class="o">=</span> <span class="mi">0</span>                           <span class="c1"># Power law breakage parameter Pandya, Spielmann </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P2</span> <span class="o">=</span> <span class="mi">1</span>                           <span class="c1"># Power law breakage parameter Pandya, Spielmann </span>
            
        <span class="c1">## GENERAL constants</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">KT</span> <span class="o">=</span> <span class="mf">1.38</span><span class="o">*</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">23</span><span class="p">)</span><span class="o">*</span><span class="mi">293</span>          <span class="c1"># k*T in [J]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MU0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">7</span>           <span class="c1"># Permeability constant vacuum [N/A²]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EPS0</span> <span class="o">=</span> <span class="mf">8.854</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">12</span>             <span class="c1"># Permettivity constant vacuum [F/m]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EPSR</span> <span class="o">=</span> <span class="mi">80</span>                        <span class="c1"># Permettivity material factor [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">EPS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">EPSR</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">EPS0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="mf">1.602</span><span class="o">*</span><span class="mi">10</span><span class="o">**-</span><span class="mi">19</span>                <span class="c1"># Electron charge [C]    </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NA</span> <span class="o">=</span> <span class="mf">6.022</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="mi">23</span>                <span class="c1"># Avogadro number [1/mol]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MU_W</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**-</span><span class="mi">3</span>                    <span class="c1"># Viscosity water [Pa*s]</span>
        
        <span class="c1">## EXPERIMENTAL / PROCESS parameters:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_exp</span> <span class="o">=</span> <span class="n">t_exp</span>                       <span class="c1"># Agglomeration time [min]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">I</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="o">*</span><span class="mf">1e3</span>                     <span class="c1"># Ionic strength [mol/m³] - CARE: Standard unit is mol/L</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c_mag_exp</span> <span class="o">=</span> <span class="mf">0.01</span>                 <span class="c1"># Volume concentration of magnetic particles [Vol-%] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Psi_c1_exp</span> <span class="o">=</span> <span class="mi">1</span>                   <span class="c1"># Concentration ratio component 1 (V_NM1/V_M) [-] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Psi_c2_exp</span> <span class="o">=</span> <span class="mi">1</span>                   <span class="c1"># Concentration ratio component 2 (V_NM2/V_M) [-] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_mag_exp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Psi_c1_exp</span>   <span class="c1"># Volume concentration of NM1 particles [Vol-%] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cv_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_mag_exp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Psi_c2_exp</span>   <span class="c1"># Volume concentration of NM2 particles [Vol-%] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_exp</span> <span class="o">=</span> <span class="mi">250</span>                      <span class="c1"># Rotary speed [1/min]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PROCESS_VOL</span> <span class="o">=</span> <span class="mf">0.025</span>              <span class="c1"># OLD, had influence! Process volume [L] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B0</span> <span class="o">=</span> <span class="mi">0</span>                           <span class="c1"># Magnetic Field strength [T]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span> <span class="o">=</span> <span class="mi">1</span>                            <span class="c1"># Shear rate [1/s]. Can be defined dependent on rotary speed, </span>
                                            <span class="c1"># e.g. G=(1400-354)*(n_exp-100)/(250-100)+354</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CORR_BETA</span> <span class="o">=</span> <span class="mf">1e6</span><span class="o">*</span><span class="mf">2.5e-5</span>           <span class="c1"># Correction Term for collision frequency [-]. Can be defined</span>
                                            <span class="c1"># dependent on rotary speed, e.g. ((corr_beta250-corr_beta100)*(n_exp-100)/(250-100)+corr_beta100)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V01</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_1</span><span class="o">*</span><span class="mf">1e-2</span>             <span class="c1"># Total volume concentration of component 1 [m³/m³] - NM1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N01</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V01</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R01</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>     <span class="c1"># Total number concentration of primary particles component 1 [1/m³] - NM1 (if no PSD)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V02</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cv_2</span><span class="o">*</span><span class="mf">1e-2</span>             <span class="c1"># Total volume concentration of component 2 [m³/m³] - NM2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N02</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V02</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R02</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>     <span class="c1"># Total number concentration of primary particles component 2 [1/m³] - NM2 (if no PSD)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V03</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_mag_exp</span><span class="o">*</span><span class="mf">1e-2</span>        <span class="c1"># Total volume concentration of component 3 [m³/m³] - M</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N03</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">V03</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R03</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>     <span class="c1"># Total number concentration of primary particles component 1 [1/m³] - M (if no PSD)   </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_INF</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NA</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span>           <span class="c1"># Total number concentration of ions [1/m³] </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t_exp</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">DEL_T</span><span class="p">)</span>      <span class="c1"># Number of timesteps for calculation [-]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NUM_T</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">DEL_T</span>        
        
        <span class="c1"># Initialize **attr</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            
        <span class="c1"># Initialize from file</span>
        <span class="k">if</span> <span class="n">file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>        
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="c1"># Reset dimension</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="n">dim</span>
            
    <span class="c1">### ------ Static Methods ------ ### </span>
    
    <span class="c1">## Initialize PSD</span>
<div class="viewcode-block" id="population.initialize_psd"><a class="viewcode-back" href="../pop.html#pop.population.initialize_psd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">initialize_psd</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">psd_data</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">x_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Q_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        
        <span class="c1">## OUTPUT-parameters:</span>
        <span class="c1"># n: NUMBER concentration vector corresponding to r (for direct usage in N</span>
        <span class="c1"># vector of population balance calculation</span>
        
        <span class="c1">## INPUT-parameters:</span>
        <span class="c1"># r: Particle size grid on which the PSD should be initialized. NOTE: This</span>
        <span class="c1">#    vector contains RADII (and NOT diameters)</span>
        <span class="c1"># PSD_data: Complete path (including filename) to datafile in which the PSD is saved. </span>
        <span class="c1">#           This file should only contain 2 variables: Q_PSD and x_PSD.</span>
        <span class="c1">#           Here, x_PSD contains diameters (standard format of PSD)</span>
        <span class="c1"># v0: Total VOLUME the distribution should be scaled to</span>
                
        
        <span class="c1"># If x and Q are not directly given import from file</span>
        <span class="k">if</span> <span class="n">x_init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Q_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Import x values from dictionary save in psd_data</span>
            <span class="n">psd_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">psd_data</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">psd_dict</span><span class="p">[</span><span class="s1">&#39;x_PSD&#39;</span><span class="p">]</span>
            
            <span class="c1">## Initializing the variables</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> 
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
            
            <span class="k">if</span> <span class="s1">&#39;Q_PSD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd_dict</span> <span class="ow">and</span> <span class="s1">&#39;q_PSD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd_dict</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: Neither Q_PSD nor q_PSD given in distribution file. Exiting..&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;Q_PSD&#39;</span> <span class="ow">in</span> <span class="n">psd_dict</span><span class="p">:</span>
                <span class="c1"># Load Q if given</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">psd_dict</span><span class="p">[</span><span class="s1">&#39;Q_PSD&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;q_PSD&#39;</span> <span class="ow">in</span> <span class="n">psd_dict</span><span class="p">:</span>
                <span class="c1"># Load q if given</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">psd_dict</span><span class="p">[</span><span class="s1">&#39;q_PSD&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If q is not given: Calculate from Q. Note that q[0] will always be zero</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                    <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Q</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> 
                    
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Initializing the variables</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">))</span> 
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_init</span><span class="p">))</span> 
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_init</span>
            
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
                <span class="n">q</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Q_init</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">Q_init</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            
        <span class="c1"># Transform x from diameter to radius information. Also transform q</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">/</span><span class="mi">2</span>
        <span class="c1">#q = q/2</span>
        
        <span class="c1"># Interpolate q on r grid and normalize it to 1 (account for numerical error)</span>
        <span class="c1"># If the ranges don&#39;t match well, insert 0. This is legit since it is the density</span>
        <span class="c1"># distribution</span>
        <span class="n">f_q</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">f_q</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                
        <span class="c1">#q_r(math.isnan(q_r)) = 0</span>
        <span class="n">q_r</span> <span class="o">=</span> <span class="n">q_r</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span><span class="n">q_r</span><span class="p">,</span><span class="n">r</span><span class="p">)</span>
        
        <span class="c1"># Temporary r vector. Add lower and upper boarder (given by x_PSD) </span>
        <span class="c1"># This allows calculation of the first and last entry of q / r.</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> 
        <span class="n">qt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>  
        <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">min</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">rt</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>
        <span class="n">rt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span> 
        <span class="n">qt</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q_r</span><span class="p">;</span>
        
        <span class="c1"># Calculate concentration vector</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">rt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">v_total_tmp</span> <span class="o">=</span> <span class="n">v0</span><span class="o">*</span><span class="n">qt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="p">((</span><span class="n">rt</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rt</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">rt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">rt</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># Calculated with DIFFERENCE (i+1), (i-1)</span>
            <span class="c1">#v_one_tmp = (4/3)*pi*((rt[i+1]+rt[i-1])*1e-6/2)^3; # Calculated with MEAN (i+1), (i-1) </span>
            <span class="n">v_one_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span><span class="p">;</span> <span class="c1"># Calculated with MEAN (i+1), (i-1) </span>
            <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_total_tmp</span><span class="o">/</span><span class="n">v_one_tmp</span><span class="p">;</span>
        
        <span class="c1"># Eliminate sub and near zero values (sub-thrshold)</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="n">n</span><span class="p">[</span><span class="n">n</span><span class="o">&lt;</span><span class="n">thr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">n</span>   </div>

    <span class="c1">## Initialize PSD</span>
<div class="viewcode-block" id="population.new_initialize_psd"><a class="viewcode-back" href="../pop.html#pop.population.new_initialize_psd">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">new_initialize_psd</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="n">psd_data</span><span class="p">,</span><span class="n">v0</span><span class="p">,</span><span class="n">x_init</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">Q_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            
        <span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
        <span class="kn">import</span> <span class="nn">sys</span>
        
        <span class="c1">## OUTPUT-parameters:</span>
        <span class="c1"># n: NUMBER concentration vector corresponding to 2*r (for direct usage in N</span>
        <span class="c1"># vector of population balance calculation</span>
        
        <span class="c1">## INPUT-parameters:</span>
        <span class="c1"># d: Particle size grid on which the PSD should be initialized. NOTE: This</span>
        <span class="c1">#    vector contains diameters</span>
        <span class="c1"># PSD_data: Complete path (including filename) to datafile in which the PSD is saved. </span>
        <span class="c1">#           This file should only contain 2 variables: Q_PSD and x_PSD.</span>
        <span class="c1">#           Here, x_PSD contains diameters (standard format of PSD)</span>
        <span class="c1"># v0: Total VOLUME the distribution should be scaled to</span>
                
        
        <span class="c1"># If x and Q are not directly given import from file</span>
        <span class="k">if</span> <span class="n">x_init</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">Q_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Import x values from dictionary save in psd_data</span>
            <span class="n">psd_dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">psd_data</span><span class="p">,</span><span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">psd_dict</span><span class="p">[</span><span class="s1">&#39;x_PSD&#39;</span><span class="p">]</span>
            
            <span class="c1">## Initializing the variables</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> 
            
            <span class="k">if</span> <span class="s1">&#39;Q_PSD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd_dict</span> <span class="ow">and</span> <span class="s1">&#39;q_PSD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">psd_dict</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;ERROR: Neither Q_PSD nor q_PSD given in distribution file. Exiting..&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="s1">&#39;Q_PSD&#39;</span> <span class="ow">in</span> <span class="n">psd_dict</span><span class="p">:</span>
                <span class="c1"># Load Q if given</span>
                <span class="n">Q</span> <span class="o">=</span> <span class="n">psd_dict</span><span class="p">[</span><span class="s1">&#39;Q_PSD&#39;</span><span class="p">]</span>
                    
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">## Initializing the variables</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">))</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_init</span>
            <span class="n">Q</span> <span class="o">=</span> <span class="n">Q_init</span>
        
        <span class="c1"># Interpolate Q on d grid and normalize it to 1 (account for numerical error)</span>
        <span class="c1"># If the ranges don&#39;t match well, insert 0. This is legit since it is the density</span>
        <span class="c1"># distribution</span>
        <span class="n">f_Q</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">Q_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Q_d</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">f_Q</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                
        <span class="c1">#Q_d(math.isnan(Q_d)) = 0</span>
        <span class="n">Q_d</span> <span class="o">=</span> <span class="n">Q_d</span><span class="o">/</span><span class="n">Q_d</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">v_total_tmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">v0</span> <span class="o">*</span> <span class="p">(</span><span class="n">Q_d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Q_d</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">v_one_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">n</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v_total_tmp</span><span class="o">/</span><span class="n">v_one_tmp</span>
        
        <span class="c1"># Eliminate sub and near zero values (sub-thrshold)</span>
        <span class="n">thr</span> <span class="o">=</span> <span class="mf">1e-5</span>
        <span class="n">n</span><span class="p">[</span><span class="n">n</span><span class="o">&lt;</span><span class="n">thr</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">n</span>    </div>
    <span class="c1">## Plot 2D-distribution:</span>
<div class="viewcode-block" id="population.plot_N2D"><a class="viewcode-back" href="../pop.html#pop.population.plot_N2D">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">plot_N2D</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">V0_tot</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">close_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">scl_a4</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="p">[</span><span class="mf">12.8</span><span class="o">*</span><span class="mf">1.05</span><span class="p">,</span><span class="mf">12.8</span><span class="p">],</span><span class="n">THR_N</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span>
                 <span class="n">exp_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">t_stamp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                    
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
        <span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
        <span class="kn">import</span> <span class="nn">plotter.plotter</span> <span class="k">as</span> <span class="nn">pt</span>
        <span class="kn">from</span> <span class="nn">plotter.KIT_cmap</span> <span class="kn">import</span> <span class="n">KIT_black_green_white</span>
        
        <span class="k">if</span> <span class="n">close_all</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">fig</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pt</span><span class="o">.</span><span class="n">plot_init</span><span class="p">(</span><span class="n">scl_a4</span><span class="o">=</span><span class="n">scl_a4</span><span class="p">,</span><span class="n">figsze</span><span class="o">=</span><span class="n">figsze</span><span class="p">,</span><span class="n">lnewdth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">mrksze</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">use_locale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">scl</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>    
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Clear axes</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
        
        <span class="c1"># Calculate meshgrid for plot</span>
        <span class="n">_ii</span><span class="p">,</span> <span class="n">_jj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">N</span><span class="p">)))</span>
                        
        <span class="c1"># Calculate relative Volume and apply threshold</span>
        <span class="n">Nr</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="n">V</span><span class="p">)</span><span class="o">/</span><span class="n">V0_tot</span>
        <span class="n">Nr</span><span class="p">[</span><span class="n">Nr</span><span class="o">&lt;</span><span class="n">THR_N</span><span class="p">]</span><span class="o">=</span><span class="n">THR_N</span>
        
        <span class="c1"># Color plot</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolor</span><span class="p">(</span><span class="n">_ii</span><span class="p">,</span><span class="n">_jj</span><span class="p">,</span><span class="n">Nr</span><span class="p">,</span><span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mf">1e3</span><span class="o">*</span><span class="n">THR_N</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">100</span><span class="p">),</span><span class="n">edgecolors</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">],</span>
                       <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">KIT_black_green_white</span><span class="o">.</span><span class="n">reversed</span><span class="p">())</span> 
        
        <span class="c1"># Colorbar / legend</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span><span class="n">cax</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Total volume $V$ / $\%$&#39;</span><span class="p">)</span>
       
        <span class="c1"># Format the plot</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Partial volume comp. 1 $V_</span><span class="si">{1}</span><span class="s1">$ ($i$) / $-$&#39;</span><span class="p">)</span>  <span class="c1"># Add an x-label to the axes.</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Partial volume comp. 2 $V_</span><span class="si">{2}</span><span class="s1">$ ($j$) / $-$&#39;</span><span class="p">)</span>  <span class="c1"># Add a y-label to the axes.</span>
        
        <span class="c1"># Plot time textbox if t_stamp is provided</span>
        <span class="k">if</span> <span class="n">t_stamp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;$t=</span><span class="si">{</span><span class="n">t_stamp</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="mf">1.6</span><span class="p">,</span>
                    <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        
        <span class="c1">#Remove whitespace around plot</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        
        <span class="c1"># Plot frame</span>
        <span class="k">if</span> <span class="n">exp_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pt</span><span class="o">.</span><span class="n">plot_export</span><span class="p">(</span><span class="n">exp_file</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">fig</span></div></div>
    
<span class="c1">### ------ PRE-COMPILED FUNCTIONS (NUMBA JIT) ------ ### </span>
 
<span class="c1"># Define np.heaviside for JIT compilation</span>
    

   
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Frank Rhein, Haoran Ji.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>